commit 5a25fd7d52540f2ed20a22adc9d5788b87467c35
Author: Samuel Kong <samuel.kong@liferay.com>
Date:   Wed Nov 18 12:51:08 2009 +0000

    LPS-6034 XSS
    
    git-svn-id: svn://svn.liferay.com/repos/public/portal/trunk@41079 05bdf26c-840f-0410-9ced-eb539d925f36

diff --git a/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java b/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
index 61f3eff7cada..7bcc1d31f0ee 100644
--- a/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
+++ b/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
@@ -219,6 +219,10 @@ public class PortletPreferencesLocalServiceImpl
 					ownerId, ownerType, plid, portletId);
 
 			if (portletPreferences == null) {
+				if ((portlet != null) && portlet.isUndeployedPortlet()) {
+					return new PortletPreferencesImpl();
+				}
+
 				portletPreferences =
 					portletPreferencesLocalService.addPortletPreferences(
 						companyId, ownerId, ownerType, plid, portletId, portlet,
diff --git a/portal-web/docroot/html/portal/render_portlet.jsp b/portal-web/docroot/html/portal/render_portlet.jsp
index ee7a1e3b4d6f..e64babae790a 100644
--- a/portal-web/docroot/html/portal/render_portlet.jsp
+++ b/portal-web/docroot/html/portal/render_portlet.jsp
@@ -49,7 +49,7 @@ try {
 			throw new NoSuchResourceException();
 		}
 	}
-	else {
+	else if (!portlet.isUndeployedPortlet()) {
 		ResourceLocalServiceUtil.getResource(company.getCompanyId(), rootPortletId, ResourceConstants.SCOPE_INDIVIDUAL, portletPrimaryKey);
 	}
 }
@@ -960,7 +960,7 @@ else {
 					isStatic: '<%= staticVar %>',
 					namespacedId: 'p_p_id<%= UnicodeFormatter.toString(renderResponseImpl.getNamespace()) %>',
 					portletId: '<%= UnicodeFormatter.toString(portletDisplay.getId()) %>',
-					refreshURL: '<%= PortletURLUtil.getRefreshURL(request, themeDisplay) %>'
+					refreshURL: '<%= UnicodeFormatter.toString(PortletURLUtil.getRefreshURL(request, themeDisplay)) %>'
 				}
 			);
 		</script>