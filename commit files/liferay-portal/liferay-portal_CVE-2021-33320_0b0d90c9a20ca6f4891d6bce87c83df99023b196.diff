commit 0b0d90c9a20ca6f4891d6bce87c83df99023b196
Author: Alejandro Tardín <alejandro.tardin@liferay.com>
Date:   Thu Apr 2 15:41:49 2020 +0200

    LPS-103587 Adding commands to serve the captcha for flags

diff --git a/modules/apps/flags/flags-web/build.gradle b/modules/apps/flags/flags-web/build.gradle
index fd6f821058eb..e2c8874e1585 100644
--- a/modules/apps/flags/flags-web/build.gradle
+++ b/modules/apps/flags/flags-web/build.gradle
@@ -6,6 +6,8 @@ dependencies {
 	compileOnly group: "javax.portlet", name: "portlet-api", version: "3.0.1"
 	compileOnly group: "org.apache.felix", name: "org.apache.felix.http.servlet-api", version: "1.1.2"
 	compileOnly group: "org.osgi", name: "org.osgi.service.component.annotations", version: "1.3.0"
+	compileOnly project(":apps:captcha:captcha-api")
+	compileOnly project(":apps:captcha:captcha-taglib")
 	compileOnly project(":apps:flags:flags-api")
 	compileOnly project(":apps:flags:flags-taglib")
 	compileOnly project(":apps:frontend-taglib:frontend-taglib")
diff --git a/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/CaptchaMVCResourceCommand.java b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/CaptchaMVCResourceCommand.java
new file mode 100644
index 000000000000..9539f6a2646e
--- /dev/null
+++ b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/CaptchaMVCResourceCommand.java
@@ -0,0 +1,57 @@
+/**
+ * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
+ *
+ * This library is free software; you can redistribute it and/or modify it under
+ * the terms of the GNU Lesser General Public License as published by the Free
+ * Software Foundation; either version 2.1 of the License, or (at your option)
+ * any later version.
+ *
+ * This library is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
+ * details.
+ */
+
+package com.liferay.flags.web.internal.portlet.action;
+
+import com.liferay.captcha.util.CaptchaUtil;
+import com.liferay.flags.web.internal.constants.FlagsPortletKeys;
+import com.liferay.portal.kernel.portlet.bridges.mvc.MVCResourceCommand;
+
+import java.io.IOException;
+
+import javax.portlet.PortletException;
+import javax.portlet.ResourceRequest;
+import javax.portlet.ResourceResponse;
+
+import org.osgi.service.component.annotations.Component;
+
+/**
+ * @author Alejandro Tardín
+ */
+@Component(
+	immediate = true,
+	property = {
+		"javax.portlet.name=" + FlagsPortletKeys.FLAGS,
+		"mvc.command.name=/flags/captcha_image"
+	},
+	service = MVCResourceCommand.class
+)
+public class CaptchaMVCResourceCommand implements MVCResourceCommand {
+
+	@Override
+	public boolean serveResource(
+			ResourceRequest resourceRequest, ResourceResponse resourceResponse)
+		throws PortletException {
+
+		try {
+			CaptchaUtil.serveImage(resourceRequest, resourceResponse);
+
+			return false;
+		}
+		catch (IOException ioException) {
+			throw new PortletException(ioException);
+		}
+	}
+
+}
\ No newline at end of file
diff --git a/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/GetCaptchaMVCResourceCommand.java b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/GetCaptchaMVCResourceCommand.java
new file mode 100644
index 000000000000..68134a0f8fde
--- /dev/null
+++ b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/GetCaptchaMVCResourceCommand.java
@@ -0,0 +1,47 @@
+/**
+ * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
+ *
+ * This library is free software; you can redistribute it and/or modify it under
+ * the terms of the GNU Lesser General Public License as published by the Free
+ * Software Foundation; either version 2.1 of the License, or (at your option)
+ * any later version.
+ *
+ * This library is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
+ * details.
+ */
+
+package com.liferay.flags.web.internal.portlet.action;
+
+import com.liferay.flags.web.internal.constants.FlagsPortletKeys;
+import com.liferay.portal.kernel.portlet.bridges.mvc.BaseMVCResourceCommand;
+import com.liferay.portal.kernel.portlet.bridges.mvc.MVCResourceCommand;
+
+import javax.portlet.ResourceRequest;
+import javax.portlet.ResourceResponse;
+
+import org.osgi.service.component.annotations.Component;
+
+/**
+ * @author Alejandro Tardín
+ */
+@Component(
+	immediate = true,
+	property = {
+		"javax.portlet.name=" + FlagsPortletKeys.FLAGS,
+		"mvc.command.name=/flags/captcha"
+	},
+	service = MVCResourceCommand.class
+)
+public class GetCaptchaMVCResourceCommand extends BaseMVCResourceCommand {
+
+	@Override
+	protected void doServeResource(
+			ResourceRequest resourceRequest, ResourceResponse resourceResponse)
+		throws Exception {
+
+		include(resourceRequest, resourceResponse, "/captcha.jsp");
+	}
+
+}
\ No newline at end of file
diff --git a/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/captcha.jsp b/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/captcha.jsp
new file mode 100644
index 000000000000..43bd9ababe98
--- /dev/null
+++ b/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/captcha.jsp
@@ -0,0 +1,23 @@
+<%--
+/**
+ * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
+ *
+ * This library is free software; you can redistribute it and/or modify it under
+ * the terms of the GNU Lesser General Public License as published by the Free
+ * Software Foundation; either version 2.1 of the License, or (at your option)
+ * any later version.
+ *
+ * This library is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
+ * details.
+ */
+--%>
+
+<%@ include file="/init.jsp" %>
+
+<liferay-portlet:resourceURL copyCurrentRenderParameters="<%= false %>" id="/flags/captcha_image" var="captchaURL" />
+
+<liferay-captcha:captcha
+	url="<%= captchaURL %>"
+/>
\ No newline at end of file
diff --git a/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/init.jsp b/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/init.jsp
index c69e8de38f61..aecd27507179 100644
--- a/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/init.jsp
+++ b/modules/apps/flags/flags-web/src/main/resources/META-INF/resources/init.jsp
@@ -14,8 +14,10 @@
  */
 --%>
 
-<%@ taglib uri="http://liferay.com/tld/flags" prefix="liferay-flags" %><%@
+<%@ taglib uri="http://liferay.com/tld/captcha" prefix="liferay-captcha" %><%@
+taglib uri="http://liferay.com/tld/flags" prefix="liferay-flags" %><%@
 taglib uri="http://liferay.com/tld/frontend" prefix="liferay-frontend" %><%@
+taglib uri="http://liferay.com/tld/portlet" prefix="liferay-portlet" %><%@
 taglib uri="http://liferay.com/tld/theme" prefix="liferay-theme" %>
 
 <%@ page import="com.liferay.portal.kernel.model.Group" %><%@