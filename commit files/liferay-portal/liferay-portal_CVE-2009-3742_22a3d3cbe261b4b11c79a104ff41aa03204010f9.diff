commit 22a3d3cbe261b4b11c79a104ff41aa03204010f9
Author: Brian Chan <brian.chan@liferay.com>
Date:   Fri Nov 20 21:21:05 2009 +0000

    LPS-6034 XSS
    
    git-svn-id: svn://svn.liferay.com/repos/public/portal/trunk@41320 05bdf26c-840f-0410-9ced-eb539d925f36

diff --git a/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java b/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
index 7bcc1d31f0ee..bb36791560bb 100644
--- a/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
+++ b/portal-impl/src/com/liferay/portal/service/impl/PortletPreferencesLocalServiceImpl.java
@@ -219,7 +219,9 @@ public class PortletPreferencesLocalServiceImpl
 					ownerId, ownerType, plid, portletId);
 
 			if (portletPreferences == null) {
-				if ((portlet != null) && portlet.isUndeployedPortlet()) {
+				if ((portlet != null) && portlet.isUndeployedPortlet() &&
+					PortletPreferencesThreadLocal.isStrict()) {
+
 					return new PortletPreferencesImpl();
 				}
 
diff --git a/portal-service/src/com/liferay/portlet/PortletPreferencesThreadLocal.java b/portal-service/src/com/liferay/portlet/PortletPreferencesThreadLocal.java
new file mode 100644
index 000000000000..c6c03a82037c
--- /dev/null
+++ b/portal-service/src/com/liferay/portlet/PortletPreferencesThreadLocal.java
@@ -0,0 +1,46 @@
+/**
+ * Copyright (c) 2000-2009 Liferay, Inc. All rights reserved.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a copy
+ * of this software and associated documentation files (the "Software"), to deal
+ * in the Software without restriction, including without limitation the rights
+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+ * copies of the Software, and to permit persons to whom the Software is
+ * furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ */
+
+package com.liferay.portlet;
+
+import com.liferay.portal.kernel.util.InitialThreadLocal;
+
+/**
+ * <a href="PortletPreferencesThreadLocal.java.html"><b><i>View Source</i></b>
+ * </a>
+ *
+ * @author Brian Wing Shun Chan
+ */
+public class PortletPreferencesThreadLocal {
+
+	public static boolean isStrict() {
+		return _strict.get().booleanValue();
+	}
+
+	public static void setStrict(boolean strict) {
+		_strict.set(strict);
+	}
+
+	private static ThreadLocal<Boolean> _strict =
+		new InitialThreadLocal<Boolean>(true);
+
+}
\ No newline at end of file