commit c274219e91a092577642117424a3402ff82e73f7
Author: Mika Koivisto <mika.koivisto@liferay.com>
Date:   Fri Apr 15 16:03:09 2016 +0300

    LPS-64814 Upgrade company key

diff --git a/portal-impl/src/com/liferay/portal/upgrade/UpgradeProcess_7_0_1.java b/portal-impl/src/com/liferay/portal/upgrade/UpgradeProcess_7_0_1.java
index 422aaacfaaf6..a5b7a80bdb6e 100644
--- a/portal-impl/src/com/liferay/portal/upgrade/UpgradeProcess_7_0_1.java
+++ b/portal-impl/src/com/liferay/portal/upgrade/UpgradeProcess_7_0_1.java
@@ -16,6 +16,7 @@ package com.liferay.portal.upgrade;
 
 import com.liferay.portal.kernel.upgrade.UpgradeProcess;
 import com.liferay.portal.kernel.util.ReleaseInfo;
+import com.liferay.portal.upgrade.v7_0_1.UpgradeCompany;
 
 /**
  * @author Brian Wing Shun Chan
@@ -29,6 +30,8 @@ public class UpgradeProcess_7_0_1 extends UpgradeProcess {
 
 	@Override
 	protected void doUpgrade() throws Exception {
+		upgrade(UpgradeCompany.class);
+
 		clearIndexesCache();
 	}
 
diff --git a/portal-impl/src/com/liferay/portal/upgrade/v7_0_1/UpgradeCompany.java b/portal-impl/src/com/liferay/portal/upgrade/v7_0_1/UpgradeCompany.java
new file mode 100644
index 000000000000..fbf6f423ed92
--- /dev/null
+++ b/portal-impl/src/com/liferay/portal/upgrade/v7_0_1/UpgradeCompany.java
@@ -0,0 +1,58 @@
+/**
+ * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
+ *
+ * This library is free software; you can redistribute it and/or modify it under
+ * the terms of the GNU Lesser General Public License as published by the Free
+ * Software Foundation; either version 2.1 of the License, or (at your option)
+ * any later version.
+ *
+ * This library is distributed in the hope that it will be useful, but WITHOUT
+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
+ * details.
+ */
+
+package com.liferay.portal.upgrade.v7_0_1;
+
+import com.liferay.portal.kernel.upgrade.UpgradeProcess;
+import com.liferay.portal.kernel.util.Base64;
+import com.liferay.portal.kernel.util.LoggingTimer;
+import com.liferay.util.Encryptor;
+
+import java.security.Key;
+
+import java.sql.PreparedStatement;
+import java.sql.ResultSet;
+
+/**
+ * @author Mika Koivisto
+ */
+public class UpgradeCompany extends UpgradeProcess {
+
+	@Override
+	protected void doUpgrade() throws Exception {
+		updateCompanyKey();
+	}
+
+	protected void updateCompanyKey() throws Exception {
+		try (LoggingTimer loggingTimer = new LoggingTimer();
+			PreparedStatement ps = connection.prepareStatement(
+				"select companyId, key_ from Company");
+			ResultSet rs = ps.executeQuery()) {
+
+			while (rs.next()) {
+				String companyId = rs.getString("companyId");
+				String keyString = rs.getString("key_");
+
+				Key key = (Key)Base64.stringToObject(keyString);
+
+				keyString = Encryptor.serializeKey(key);
+
+				runSQL(
+					"update Company set key_ = '" + keyString +
+						"' where companyId = " + companyId);
+			}
+		}
+	}
+
+}
\ No newline at end of file