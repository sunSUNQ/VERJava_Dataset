commit 1ce6b6aaa60dde8aeb71a433bf98367499dd16fd
Author: Carlos Sierra Andr√©s <carlos.sierra@liferay.com>
Date:   Thu Nov 5 18:35:49 2020 +0100

    LPS-123162 Remove form parameter

diff --git a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/init.jsp b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/init.jsp
index 90ddc2e62f98..21b81a5e77a6 100755
--- a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/init.jsp
+++ b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/init.jsp
@@ -23,7 +23,6 @@ taglib uri="http://liferay.com/tld/ui" prefix="liferay-ui" %><%@
 taglib uri="http://liferay.com/tld/util" prefix="liferay-util" %>
 
 <%@ page import="com.liferay.multi.factor.authentication.timebased.otp.web.internal.constants.MFATimeBasedOTPWebKeys" %><%@
-page import="com.liferay.portal.kernel.model.User" %><%@
 page import="com.liferay.portal.kernel.util.GetterUtil" %><%@
 page import="com.liferay.portal.kernel.util.HtmlUtil" %><%@
 page import="com.liferay.portal.kernel.util.PortalUtil" %>
diff --git a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/mfa_timebased_otp_checker/setup.jsp b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/mfa_timebased_otp_checker/setup.jsp
index d6dea1993ed5..1234ad9e5bd9 100755
--- a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/mfa_timebased_otp_checker/setup.jsp
+++ b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-timebased-otp-web/src/main/resources/META-INF/resources/mfa_timebased_otp_checker/setup.jsp
@@ -22,7 +22,6 @@ String mfaTimeBasedOTPCompanyName = GetterUtil.getString(request.getAttribute(MF
 int mfaTimeBasedOTPDigits = GetterUtil.getInteger(request.getAttribute(MFATimeBasedOTPWebKeys.MFA_TIME_BASED_OTP_DIGITS));
 String mfaTimeBasedOTPSharedSecret = GetterUtil.getString(request.getAttribute(MFATimeBasedOTPWebKeys.MFA_TIME_BASED_OTP_SHARED_SECRET));
 int mfaTimeBasedOTPTimeCounter = GetterUtil.getInteger(request.getAttribute(MFATimeBasedOTPWebKeys.MFA_TIME_BASED_OTP_TIME_COUNTER));
-User selectedUser = PortalUtil.getSelectedUser(request);
 %>
 
 <div class="sheet-section">
@@ -42,7 +41,7 @@ User selectedUser = PortalUtil.getSelectedUser(request);
 </div>
 
 <aui:script require='<%= npmResolvedPackageName + "/qrcode/generateQRCode as generateQRCode" %>'>
-	var account = '<%= HtmlUtil.escapeJS(selectedUser.getEmailAddress()) %>';
+	var account = '<%= HtmlUtil.escapeJS(user.getEmailAddress()) %>';
 	var algorithm = '<%= HtmlUtil.escapeJS(mfaTimeBasedOTPAlgorithm) %>';
 	var counter = '<%= mfaTimeBasedOTPTimeCounter %>';
 	var digits = '<%= mfaTimeBasedOTPDigits %>';
diff --git a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/java/com/liferay/multi/factor/authentication/web/internal/portlet/action/MFAUserAccountSetupMVCActionCommand.java b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/java/com/liferay/multi/factor/authentication/web/internal/portlet/action/MFAUserAccountSetupMVCActionCommand.java
index c4c44943f877..a494ffd4cbdc 100644
--- a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/java/com/liferay/multi/factor/authentication/web/internal/portlet/action/MFAUserAccountSetupMVCActionCommand.java
+++ b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/java/com/liferay/multi/factor/authentication/web/internal/portlet/action/MFAUserAccountSetupMVCActionCommand.java
@@ -22,6 +22,7 @@ import com.liferay.portal.kernel.log.Log;
 import com.liferay.portal.kernel.log.LogFactoryUtil;
 import com.liferay.portal.kernel.portlet.bridges.mvc.BaseMVCActionCommand;
 import com.liferay.portal.kernel.portlet.bridges.mvc.MVCActionCommand;
+import com.liferay.portal.kernel.security.auth.PrincipalException;
 import com.liferay.portal.kernel.servlet.SessionErrors;
 import com.liferay.portal.kernel.theme.ThemeDisplay;
 import com.liferay.portal.kernel.util.ParamUtil;
@@ -84,15 +85,20 @@ public class MFAUserAccountSetupMVCActionCommand extends BaseMVCActionCommand {
 			return;
 		}
 
-		long setupMFACheckerUserId = ParamUtil.getLong(
-			actionRequest, "setupMFACheckerUserId");
+		ThemeDisplay themeDisplay = (ThemeDisplay)actionRequest.getAttribute(
+			WebKeys.THEME_DISPLAY);
+
+		if (themeDisplay == null) {
+			throw new PrincipalException();
+		}
+
+		final long userId = themeDisplay.getUserId();
 
 		if (ParamUtil.getBoolean(actionRequest, "mfaRemoveExistingSetup")) {
-			setupMFAChecker.removeExistingSetup(setupMFACheckerUserId);
+			setupMFAChecker.removeExistingSetup(userId);
 		}
 		else if (!setupMFAChecker.setUp(
-					_portal.getHttpServletRequest(actionRequest),
-					setupMFACheckerUserId)) {
+					_portal.getHttpServletRequest(actionRequest), userId)) {
 
 			SessionErrors.add(actionRequest, "userAccountSetupFailed");
 		}
@@ -101,9 +107,6 @@ public class MFAUserAccountSetupMVCActionCommand extends BaseMVCActionCommand {
 			ParamUtil.getString(actionRequest, "redirect"));
 
 		if (Validator.isBlank(redirect)) {
-			ThemeDisplay themeDisplay =
-				(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
-
 			redirect = themeDisplay.getPortalURL();
 		}
 
diff --git a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/init.jsp b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/init.jsp
index 2e311e3d4503..9ae6309924b7 100644
--- a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/init.jsp
+++ b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/init.jsp
@@ -27,11 +27,9 @@ taglib uri="http://liferay.com/tld/ui" prefix="liferay-ui" %>
 page import="com.liferay.multi.factor.authentication.spi.checker.setup.SetupMFAChecker" %><%@
 page import="com.liferay.multi.factor.authentication.web.internal.constants.MFAWebKeys" %><%@
 page import="com.liferay.portal.kernel.language.LanguageUtil" %><%@
-page import="com.liferay.portal.kernel.model.User" %><%@
 page import="com.liferay.portal.kernel.util.GetterUtil" %><%@
 page import="com.liferay.portal.kernel.util.HtmlUtil" %><%@
-page import="com.liferay.portal.kernel.util.ParamUtil" %><%@
-page import="com.liferay.portal.kernel.util.PortalUtil" %>
+page import="com.liferay.portal.kernel.util.ParamUtil" %>
 
 <%@ page import="java.util.List" %>
 
diff --git a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/my_account/user_account_setup.jsp b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/my_account/user_account_setup.jsp
index 1181716afa97..6e8ba50b3340 100644
--- a/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/my_account/user_account_setup.jsp
+++ b/modules/dxp/apps/multi-factor-authentication/multi-factor-authentication-web/src/main/resources/META-INF/resources/my_account/user_account_setup.jsp
@@ -18,7 +18,6 @@
 
 <%
 String mfaUserAccountLabel = GetterUtil.getString(request.getAttribute(MFAWebKeys.MFA_USER_ACCOUNT_LABEL));
-User selectedUser = PortalUtil.getSelectedUser(request);
 SetupMFAChecker setupMFAChecker = (SetupMFAChecker)request.getAttribute(SetupMFAChecker.class.getName());
 %>
 
@@ -29,7 +28,6 @@ SetupMFAChecker setupMFAChecker = (SetupMFAChecker)request.getAttribute(SetupMFA
 <aui:form action="<%= actionURL %>" cssClass="portlet-users-admin-edit-user" data-senna-off="true" method="post" name="fm">
 	<aui:input name="redirect" type="hidden" value="<%= currentURL %>" />
 	<aui:input name="setupMFACheckerServiceId" type="hidden" value="<%= GetterUtil.getLong(request.getAttribute(MFAWebKeys.SETUP_MFA_CHECKER_SERVICE_ID)) %>" />
-	<aui:input name="setupMFACheckerUserId" type="hidden" value="<%= selectedUser.getUserId() %>" />
 
 	<div class="sheet sheet-lg">
 		<div class="sheet-header">
@@ -39,7 +37,7 @@ SetupMFAChecker setupMFAChecker = (SetupMFAChecker)request.getAttribute(SetupMFA
 		<liferay-ui:error key="userAccountSetupFailed" message="user-account-setup-failed" />
 
 		<%
-		setupMFAChecker.includeSetup(request, response, selectedUser.getUserId());
+		setupMFAChecker.includeSetup(request, response, user.getUserId());
 		%>
 
 	</div>