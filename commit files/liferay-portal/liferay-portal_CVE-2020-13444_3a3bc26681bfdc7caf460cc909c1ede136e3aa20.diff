commit 3a3bc26681bfdc7caf460cc909c1ede136e3aa20
Author: Raymond Auge <raymond.auge@liferay.com>
Date:   Tue Sep 28 14:52:42 2010 +0000

    LPS-12912 Support for Uuid from LDAP does not work
    
    git-svn-id: svn://svn.liferay.com/repos/public/portal/trunk@63229 05bdf26c-840f-0410-9ced-eb539d925f36

diff --git a/portal-impl/src/com/liferay/portal/security/ldap/BaseLDAPToPortalConverter.java b/portal-impl/src/com/liferay/portal/security/ldap/BaseLDAPToPortalConverter.java
index ba13a77b82a2..2632e14411aa 100644
--- a/portal-impl/src/com/liferay/portal/security/ldap/BaseLDAPToPortalConverter.java
+++ b/portal-impl/src/com/liferay/portal/security/ldap/BaseLDAPToPortalConverter.java
@@ -102,6 +102,8 @@ public class BaseLDAPToPortalConverter implements LDAPToPortalConverter {
 			attributes, userMappings, UserConverterKeys.MIDDLE_NAME);
 		String lastName = LDAPUtil.getAttributeValue(
 			attributes, userMappings, UserConverterKeys.LAST_NAME);
+		String uuid = LDAPUtil.getAttributeValue(
+			attributes, userMappings, UserConverterKeys.UUID);
 
 		if (Validator.isNull(firstName) || Validator.isNull(lastName)) {
 			String fullName = LDAPUtil.getAttributeValue(
@@ -134,6 +136,8 @@ public class BaseLDAPToPortalConverter implements LDAPToPortalConverter {
 
 		ServiceContext serviceContext = new ServiceContext();
 
+		serviceContext.setUuid(uuid);
+
 		if (_log.isDebugEnabled()) {
 			_log.debug(
 				"Screen name " + screenName + " and email address " +
diff --git a/portal-impl/src/com/liferay/portal/service/impl/UserLocalServiceImpl.java b/portal-impl/src/com/liferay/portal/service/impl/UserLocalServiceImpl.java
index 73f356b7d227..0d9166b7ae88 100644
--- a/portal-impl/src/com/liferay/portal/service/impl/UserLocalServiceImpl.java
+++ b/portal-impl/src/com/liferay/portal/service/impl/UserLocalServiceImpl.java
@@ -386,6 +386,12 @@ public class UserLocalServiceImpl extends UserLocalServiceBaseImpl {
 
 		User user = userPersistence.create(userId);
 
+		String uuid = serviceContext.getUuid();
+
+		if ((serviceContext != null) && Validator.isNotNull(uuid)) {
+			user.setUuid(uuid);
+		}
+
 		user.setCompanyId(companyId);
 		user.setCreateDate(now);
 		user.setModifiedDate(now);
diff --git a/portal-service/src/com/liferay/portal/security/ldap/UserConverterKeys.java b/portal-service/src/com/liferay/portal/security/ldap/UserConverterKeys.java
index b06c3e0ee5c8..0e54e9a26bdc 100644
--- a/portal-service/src/com/liferay/portal/security/ldap/UserConverterKeys.java
+++ b/portal-service/src/com/liferay/portal/security/ldap/UserConverterKeys.java
@@ -37,4 +37,6 @@ public interface UserConverterKeys {
 
 	public static final String SCREEN_NAME = "screenName";
 
+	public static final String UUID = "uuid";
+
 }
\ No newline at end of file
diff --git a/portal-web/docroot/html/portlet/enterprise_admin/edit_ldap_server.jsp b/portal-web/docroot/html/portlet/enterprise_admin/edit_ldap_server.jsp
index 172e3844244b..8ab8e9297161 100644
--- a/portal-web/docroot/html/portlet/enterprise_admin/edit_ldap_server.jsp
+++ b/portal-web/docroot/html/portlet/enterprise_admin/edit_ldap_server.jsp
@@ -55,6 +55,7 @@ String userMappingMiddleName = StringPool.BLANK;
 String userMappingLastName = StringPool.BLANK;
 String userMappingJobTitle = StringPool.BLANK;
 String userMappingGroup = StringPool.BLANK;
+String userMappingUuid = StringPool.BLANK;
 
 for (int i = 0 ; i < userMappingArray.length ; i++) {
 	if (userMappingArray[i].indexOf("=") == -1) {
@@ -94,6 +95,9 @@ for (int i = 0 ; i < userMappingArray.length ; i++) {
 	else if (mapping[0].equals("group")) {
 		userMappingGroup = mapping[1];
 	}
+	else if (mapping[0].equals("uuid")) {
+		userMappingUuid = mapping[1];
+	}
 
 	mapping[1] = "";
 }
@@ -209,6 +213,8 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 
 		<aui:input cssClass="lfr-input-text-container" label="group" name="userMappingGroup" type="text" value="<%= userMappingGroup %>" />
 
+		<aui:input cssClass="lfr-input-text-container" label="uuid" name="userMappingUuid" type="text" value="<%= userMappingUuid %>" />
+
 		<aui:input name='<%= "settings--" + PropsKeys.LDAP_USER_MAPPINGS + postfix + "--" %>' type="hidden" />
 
 		<aui:input name='<%= "settings--" + PropsKeys.LDAP_USER_CUSTOM_MAPPINGS + postfix + "--" %>' type="hidden" value="<%= PrefsPropsUtil.getString(company.getCompanyId(), PropsKeys.LDAP_USER_CUSTOM_MAPPINGS + postfix, PropsUtil.get(PropsKeys.LDAP_USER_CUSTOM_MAPPINGS)) %>" />
@@ -274,8 +280,8 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 
 <aui:script>
 	function <portlet:namespace />saveLdap() {
-		var userMappingFields = ['screenName','password','emailAddress','fullName','firstName','middleName','lastName','jobTitle','group'];
-		var userMappingFieldValues = ['userMappingScreenName','userMappingPassword','userMappingEmailAddress','userMappingFullName','userMappingFirstName','userMappingMiddleName','userMappingLastName','userMappingJobTitle','userMappingGroup'];
+		var userMappingFields = ['screenName','password','emailAddress','fullName','firstName','middleName','lastName','jobTitle','group','uuid'];
+		var userMappingFieldValues = ['userMappingScreenName','userMappingPassword','userMappingEmailAddress','userMappingFullName','userMappingFirstName','userMappingMiddleName','userMappingLastName','userMappingJobTitle','userMappingGroup','userMappingUuid'];
 		var userMappingInput = document.<portlet:namespace />fm['<portlet:namespace />settings--<%= PropsKeys.LDAP_USER_MAPPINGS + postfix %>--'];
 
 		userMappingInput.value = '';
@@ -343,6 +349,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				data.<portlet:namespace />userMappingLastName = document.<portlet:namespace />fm['<portlet:namespace />userMappingLastName'].value;
 				data.<portlet:namespace />userMappingJobTitle = document.<portlet:namespace />fm['<portlet:namespace />userMappingJobTitle'].value;
 				data.<portlet:namespace />userMappingGroup = document.<portlet:namespace />fm['<portlet:namespace />userMappingGroup'].value;
+				data.<portlet:namespace />userMappingUuid = document.<portlet:namespace />fm['<portlet:namespace />userMappingUuid'].value;
 			}
 
 			if (url != null) {
@@ -395,6 +402,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 			var userMappingLastName = "";
 			var userMappingJobTitle = "";
 			var userMappingGroup = "";
+			var userMappingUuid = "";
 			var importGroupSearchFilter = "";
 			var groupMappingGroupName = "";
 			var groupMappingDescription = "";
@@ -430,6 +438,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				userMappingLastName = "sn";
 				userMappingJobTitle = "";
 				userMappingGroup = "";
+				userMappingUuid = "";
 				importGroupSearchFilter = "";
 				groupMappingGroupName = "";
 				groupMappingDescription = "";
@@ -451,6 +460,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				userMappingLastName = "sn";
 				userMappingJobTitle = "title";
 				userMappingGroup = "";
+				userMappingUuid = "";
 				importGroupSearchFilter = "";
 				groupMappingGroupName = "";
 				groupMappingDescription = "";
@@ -472,6 +482,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				userMappingLastName = "sn";
 				userMappingJobTitle = "";
 				userMappingGroup = "memberOf";
+				userMappingUuid = "";
 				importGroupSearchFilter = "(objectClass=group)";
 				groupMappingGroupName = "cn";
 				groupMappingDescription = "sAMAccountName";
@@ -493,6 +504,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				userMappingLastName = "sn";
 				userMappingJobTitle = "title";
 				userMappingGroup = "";
+				userMappingUuid = "";
 				importGroupSearchFilter = "";
 				groupMappingGroupName = "";
 				groupMappingDescription = "";
@@ -514,6 +526,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 				userMappingLastName = "sn";
 				userMappingJobTitle = "title";
 				userMappingGroup = "";
+				userMappingUuid = "";
 				importGroupSearchFilter = "(objectClass=groupOfUniqueNames)";
 				groupMappingGroupName = "cn";
 				groupMappingDescription = "description";
@@ -535,6 +548,7 @@ for (int i = 0 ; i < groupMappingArray.length ; i++) {
 			document.<portlet:namespace />fm['<portlet:namespace />userMappingLastName'].value = userMappingLastName;
 			document.<portlet:namespace />fm['<portlet:namespace />userMappingJobTitle'].value = userMappingJobTitle;
 			document.<portlet:namespace />fm['<portlet:namespace />userMappingGroup'].value = userMappingGroup;
+			document.<portlet:namespace />fm['<portlet:namespace />userMappingUuid'].value = userMappingUuid;
 			document.<portlet:namespace />fm['<portlet:namespace />settings--<%= PropsKeys.LDAP_IMPORT_GROUP_SEARCH_FILTER + postfix %>--'].value = importGroupSearchFilter;
 			document.<portlet:namespace />fm['<portlet:namespace />groupMappingGroupName'].value = groupMappingGroupName;
 			document.<portlet:namespace />fm['<portlet:namespace />groupMappingDescription'].value = groupMappingDescription;