commit 23584c956e21e8094a87f6c303e80951bc796aa4
Author: Alejandro Tard√≠n <alejandro.tardin@liferay.com>
Date:   Fri Apr 3 11:48:12 2020 +0200

    LPS-103587 Sending captcha error message

diff --git a/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/EditEntryMVCActionCommand.java b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/EditEntryMVCActionCommand.java
index 876f4d98185d..d5c38772f310 100644
--- a/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/EditEntryMVCActionCommand.java
+++ b/modules/apps/flags/flags-web/src/main/java/com/liferay/flags/web/internal/portlet/action/EditEntryMVCActionCommand.java
@@ -17,6 +17,8 @@ package com.liferay.flags.web.internal.portlet.action;
 import com.liferay.captcha.util.CaptchaUtil;
 import com.liferay.flags.service.FlagsEntryService;
 import com.liferay.flags.web.internal.constants.FlagsPortletKeys;
+import com.liferay.portal.kernel.captcha.CaptchaException;
+import com.liferay.portal.kernel.captcha.CaptchaTextException;
 import com.liferay.portal.kernel.json.JSONFactoryUtil;
 import com.liferay.portal.kernel.json.JSONObject;
 import com.liferay.portal.kernel.language.LanguageUtil;
@@ -79,6 +81,16 @@ public class EditEntryMVCActionCommand extends BaseMVCActionCommand {
 				className, classPK, reporterEmailAddress, reportedUserId,
 				contentTitle, contentURL, reason, serviceContext);
 		}
+		catch (CaptchaException captchaException) {
+			ThemeDisplay themeDisplay =
+				(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
+
+			jsonObject.put(
+				"error",
+				LanguageUtil.get(
+					themeDisplay.getRequest(),
+					_getCaptchaExceptionErrorMessageKey(captchaException)));
+		}
 		catch (Exception exception) {
 			_log.error(exception, exception);
 
@@ -100,6 +112,16 @@ public class EditEntryMVCActionCommand extends BaseMVCActionCommand {
 		_flagsEntryService = flagsEntryService;
 	}
 
+	private String _getCaptchaExceptionErrorMessageKey(
+		CaptchaException captchaException) {
+
+		if (captchaException instanceof CaptchaTextException) {
+			return "text-verification-failed";
+		}
+
+		return "captcha-verification-failed";
+	}
+
 	private static final Log _log = LogFactoryUtil.getLog(
 		EditEntryMVCActionCommand.class);
 