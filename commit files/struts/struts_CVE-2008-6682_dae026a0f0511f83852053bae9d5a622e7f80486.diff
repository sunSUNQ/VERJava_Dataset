commit dae026a0f0511f83852053bae9d5a622e7f80486
Author: Donald J. Brown <mrdon@apache.org>
Date:   Fri Jan 25 13:13:23 2008 +0000

    Adding a check for double quotes to help prevent XSS attacks
    WW-2427
    
    
    git-svn-id: https://svn.apache.org/repos/asf/struts/struts2/trunk@615212 13f79535-47bb-0310-9956-ffa450edef68

diff --git a/core/src/main/java/org/apache/struts2/components/Anchor.java b/core/src/main/java/org/apache/struts2/components/Anchor.java
index 9cfc6e592..374cc3b63 100644
--- a/core/src/main/java/org/apache/struts2/components/Anchor.java
+++ b/core/src/main/java/org/apache/struts2/components/Anchor.java
@@ -74,9 +74,9 @@ public class Anchor extends ClosingUIBean {
         super.evaluateExtraParams();
 
         if (href != null)
-            addParameter("href", findString(href));
+            addParameter("href", ensureAttributeSafelyNotEscaped(findString(href)));
     }
-    
+
     @StrutsTagAttribute(description="The URL.")
     public void setHref(String href) {
         this.href = href;
diff --git a/core/src/main/java/org/apache/struts2/components/UIBean.java b/core/src/main/java/org/apache/struts2/components/UIBean.java
index dafe87bdd..722d530b3 100644
--- a/core/src/main/java/org/apache/struts2/components/UIBean.java
+++ b/core/src/main/java/org/apache/struts2/components/UIBean.java
@@ -837,6 +837,20 @@ public abstract class UIBean extends Component {
         }
     }
 
+    /**
+     * Ensures an unescaped attribute value cannot be vulnerable to XSS attacks
+     *
+     * @param val The value to check
+     * @return The escaped value
+     */
+    protected String ensureAttributeSafelyNotEscaped(String val) {
+        if (val != null) {
+            return val.replaceAll("\"", "&#34;");
+        } else {
+            return "";
+        }
+    }
+
     protected void evaluateExtraParams() {
     }
 
diff --git a/core/src/test/java/org/apache/struts2/views/jsp/ui/AnchorTest.java b/core/src/test/java/org/apache/struts2/views/jsp/ui/AnchorTest.java
index 449ad2252..eee793c90 100644
--- a/core/src/test/java/org/apache/struts2/views/jsp/ui/AnchorTest.java
+++ b/core/src/test/java/org/apache/struts2/views/jsp/ui/AnchorTest.java
@@ -43,6 +43,21 @@ public class AnchorTest extends AbstractUITagTest {
         verify(AnchorTest.class.getResource("href-1.txt"));
     }
 
+    public void testSimpleBadQuote() throws Exception {
+        TestAction testAction = (TestAction) action;
+        testAction.setFoo("bar");
+
+        AnchorTag tag = new AnchorTag();
+        tag.setPageContext(pageContext);
+
+        tag.setId("mylink");
+        tag.setHref("a\"");
+        tag.doStartTag();
+        tag.doEndTag();
+
+        verify(AnchorTest.class.getResource("href-2.txt"));
+    }
+
     public void testDynamicAttribute() throws Exception {
         TestAction testAction = (TestAction) action;
         testAction.setFoo("bar");
diff --git a/core/src/test/resources/org/apache/struts2/views/jsp/ui/href-2.txt b/core/src/test/resources/org/apache/struts2/views/jsp/ui/href-2.txt
new file mode 100644
index 000000000..cfcf57184
--- /dev/null
+++ b/core/src/test/resources/org/apache/struts2/views/jsp/ui/href-2.txt
@@ -0,0 +1,4 @@
+<a
+ id="mylink"
+ href="a&#34;">
+</a>