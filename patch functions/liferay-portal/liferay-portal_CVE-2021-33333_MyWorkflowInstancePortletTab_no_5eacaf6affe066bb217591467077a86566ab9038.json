[{"cve_id": "liferay-portal", "added_line": [], "removed_line": [{"source_line_num": 18, "source_line_code": "import com.liferay.petra.string.StringBundler;"}, {"source_line_num": 19, "source_line_code": "import com.liferay.portal.kernel.exception.PortalException;"}, {"source_line_num": 20, "source_line_code": "import com.liferay.portal.kernel.log.Log;"}, {"source_line_num": 21, "source_line_code": "import com.liferay.portal.kernel.log.LogFactoryUtil;"}, {"source_line_num": 22, "source_line_code": "import com.liferay.portal.kernel.model.User;"}, {"source_line_num": 23, "source_line_code": "import com.liferay.portal.kernel.security.auth.PrincipalException;"}, {"source_line_num": 24, "source_line_code": "import com.liferay.portal.kernel.servlet.SessionErrors;"}, {"source_line_num": 25, "source_line_code": "import com.liferay.portal.kernel.theme.ThemeDisplay;"}, {"source_line_num": 26, "source_line_code": "import com.liferay.portal.kernel.util.GetterUtil;"}, {"source_line_num": 27, "source_line_code": "import com.liferay.portal.kernel.util.ParamUtil;"}, {"source_line_num": 28, "source_line_code": "import com.liferay.portal.kernel.util.WebKeys;"}, {"source_line_num": 29, "source_line_code": "import com.liferay.portal.kernel.workflow.WorkflowConstants;"}, {"source_line_num": 30, "source_line_code": "import com.liferay.portal.kernel.workflow.WorkflowException;"}, {"source_line_num": 31, "source_line_code": "import com.liferay.portal.kernel.workflow.WorkflowInstance;"}, {"source_line_num": 32, "source_line_code": "import com.liferay.portal.kernel.workflow.WorkflowInstanceManagerUtil;"}, {"source_line_num": 36, "source_line_code": "import java.io.Serializable;"}, {"source_line_num": 38, "source_line_code": "import java.util.Map;"}, {"source_line_num": 40, "source_line_code": "import javax.portlet.ActionRequest;"}, {"source_line_num": 41, "source_line_code": "import javax.portlet.ActionResponse;"}, {"source_line_num": 42, "source_line_code": "import javax.portlet.PortletContext;"}, {"source_line_num": 43, "source_line_code": "import javax.portlet.PortletException;"}, {"source_line_num": 44, "source_line_code": "import javax.portlet.PortletRequest;"}, {"source_line_num": 45, "source_line_code": "import javax.portlet.PortletRequestDispatcher;"}, {"source_line_num": 46, "source_line_code": "import javax.portlet.PortletSession;"}, {"source_line_num": 47, "source_line_code": "import javax.portlet.RenderRequest;"}, {"source_line_num": 48, "source_line_code": "import javax.portlet.RenderResponse;"}, {"source_line_num": 67, "source_line_code": "@Override"}, {"source_line_num": 68, "source_line_code": "public void prepareDispatch("}, {"source_line_num": 69, "source_line_code": "RenderRequest renderRequest, RenderResponse renderResponse)"}, {"source_line_num": 70, "source_line_code": "throws PortletException {"}, {"source_line_num": 72, "source_line_code": "if (SessionErrors.contains("}, {"source_line_num": 73, "source_line_code": "renderRequest, PrincipalException.getNestedClasses()) ||"}, {"source_line_num": 74, "source_line_code": "SessionErrors.contains("}, {"source_line_num": 75, "source_line_code": "renderRequest, WorkflowException.class.getName())) {"}, {"source_line_num": 77, "source_line_code": "PortletSession portletSession = renderRequest.getPortletSession();"}, {"source_line_num": 79, "source_line_code": "PortletContext portletContext = portletSession.getPortletContext();"}, {"source_line_num": 81, "source_line_code": "PortletRequestDispatcher portletRequestDispatcher ="}, {"source_line_num": 82, "source_line_code": "portletContext.getRequestDispatcher(\"/instance/error.jsp\");"}, {"source_line_num": 84, "source_line_code": "try {"}, {"source_line_num": 85, "source_line_code": "if (SessionErrors.contains("}, {"source_line_num": 86, "source_line_code": "renderRequest, PrincipalException.getNestedClasses())) {"}, {"source_line_num": 88, "source_line_code": "portletRequestDispatcher.forward("}, {"source_line_num": 89, "source_line_code": "renderRequest, renderResponse);"}, {"source_line_num": 91, "source_line_code": "else {"}, {"source_line_num": 92, "source_line_code": "portletRequestDispatcher.include("}, {"source_line_num": 93, "source_line_code": "renderRequest, renderResponse);"}, {"source_line_num": 96, "source_line_code": "catch (Exception exception) {"}, {"source_line_num": 97, "source_line_code": "throw new PortletException(exception);"}, {"source_line_num": 101, "source_line_code": "super.prepareDispatch(renderRequest, renderResponse);"}, {"source_line_num": 104, "source_line_code": "@Override"}, {"source_line_num": 105, "source_line_code": "public void prepareProcessAction("}, {"source_line_num": 106, "source_line_code": "ActionRequest actionRequest, ActionResponse actionResponse)"}, {"source_line_num": 107, "source_line_code": "throws PortletException {"}, {"source_line_num": 109, "source_line_code": "long workflowInstanceId = ParamUtil.getLong("}, {"source_line_num": 110, "source_line_code": "actionRequest, \"workflowInstanceId\");"}, {"source_line_num": 112, "source_line_code": "try {"}, {"source_line_num": 113, "source_line_code": "_checkWorkflowInstance(actionRequest, workflowInstanceId);"}, {"source_line_num": 115, "source_line_code": "catch (Exception exception) {"}, {"source_line_num": 116, "source_line_code": "if (workflowPreprocessorHelper.isSessionErrorException(exception)) {"}, {"source_line_num": 117, "source_line_code": "if (_log.isWarnEnabled()) {"}, {"source_line_num": 118, "source_line_code": "_log.warn(exception, exception);"}, {"source_line_num": 121, "source_line_code": "workflowPreprocessorHelper.hideDefaultErrorMessage("}, {"source_line_num": 122, "source_line_code": "actionRequest);"}, {"source_line_num": 124, "source_line_code": "SessionErrors.add(actionRequest, exception.getClass());"}, {"source_line_num": 126, "source_line_code": "else {"}, {"source_line_num": 127, "source_line_code": "throw new PortletException(exception);"}, {"source_line_num": 131, "source_line_code": "super.prepareProcessAction(actionRequest, actionResponse);"}, {"source_line_num": 134, "source_line_code": "@Override"}, {"source_line_num": 135, "source_line_code": "protected void setWorkflowInstanceRenderRequestAttribute("}, {"source_line_num": 136, "source_line_code": "RenderRequest renderRequest)"}, {"source_line_num": 137, "source_line_code": "throws PortalException {"}, {"source_line_num": 139, "source_line_code": "super.setWorkflowInstanceRenderRequestAttribute(renderRequest);"}, {"source_line_num": 141, "source_line_code": "WorkflowInstance workflowInstance ="}, {"source_line_num": 142, "source_line_code": "(WorkflowInstance)renderRequest.getAttribute("}, {"source_line_num": 143, "source_line_code": "WebKeys.WORKFLOW_INSTANCE);"}, {"source_line_num": 145, "source_line_code": "_checkWorkflowInstance(renderRequest, workflowInstance);"}, {"source_line_num": 148, "source_line_code": "private void _checkWorkflowInstance("}, {"source_line_num": 149, "source_line_code": "PortletRequest portletRequest, long workflowInstanceId)"}, {"source_line_num": 150, "source_line_code": "throws PrincipalException, WorkflowException {"}, {"source_line_num": 152, "source_line_code": "ThemeDisplay themeDisplay = (ThemeDisplay)portletRequest.getAttribute("}, {"source_line_num": 153, "source_line_code": "WebKeys.THEME_DISPLAY);"}, {"source_line_num": 155, "source_line_code": "WorkflowInstance workflowInstance ="}, {"source_line_num": 156, "source_line_code": "WorkflowInstanceManagerUtil.getWorkflowInstance("}, {"source_line_num": 157, "source_line_code": "themeDisplay.getCompanyId(), workflowInstanceId);"}, {"source_line_num": 159, "source_line_code": "_checkWorkflowInstance(portletRequest, workflowInstance);"}, {"source_line_num": 162, "source_line_code": "private void _checkWorkflowInstance("}, {"source_line_num": 163, "source_line_code": "PortletRequest portletRequest, WorkflowInstance workflowInstance)"}, {"source_line_num": 164, "source_line_code": "throws PrincipalException {"}, {"source_line_num": 166, "source_line_code": "if (workflowInstance == null) {"}, {"source_line_num": 167, "source_line_code": "return;"}, {"source_line_num": 170, "source_line_code": "Map<String, Serializable> workflowContext ="}, {"source_line_num": 171, "source_line_code": "workflowInstance.getWorkflowContext();"}, {"source_line_num": 173, "source_line_code": "long companyId = GetterUtil.getLong("}, {"source_line_num": 174, "source_line_code": "workflowContext.get(WorkflowConstants.CONTEXT_COMPANY_ID));"}, {"source_line_num": 175, "source_line_code": "long userId = GetterUtil.getLong("}, {"source_line_num": 176, "source_line_code": "workflowContext.get(WorkflowConstants.CONTEXT_USER_ID));"}, {"source_line_num": 178, "source_line_code": "ThemeDisplay themeDisplay = (ThemeDisplay)portletRequest.getAttribute("}, {"source_line_num": 179, "source_line_code": "WebKeys.THEME_DISPLAY);"}, {"source_line_num": 181, "source_line_code": "User user = themeDisplay.getUser();"}, {"source_line_num": 183, "source_line_code": "if ((user.getCompanyId() != companyId) ||"}, {"source_line_num": 184, "source_line_code": "(user.getUserId() != userId)) {"}, {"source_line_num": 186, "source_line_code": "StringBundler sb = new StringBundler(4);"}, {"source_line_num": 188, "source_line_code": "sb.append(\"User \");"}, {"source_line_num": 189, "source_line_code": "sb.append(userId);"}, {"source_line_num": 190, "source_line_code": "sb.append(\" is not allowed to access workflow instance \");"}, {"source_line_num": 191, "source_line_code": "sb.append(workflowInstance.getWorkflowInstanceId());"}, {"source_line_num": 193, "source_line_code": "_log.error(sb.toString());"}, {"source_line_num": 195, "source_line_code": "throw new PrincipalException();"}, {"source_line_num": 199, "source_line_code": "private static final Log _log = LogFactoryUtil.getLog("}, {"source_line_num": 200, "source_line_code": "MyWorkflowInstancePortletTab.class);"}], "filename": "modules/apps/portal-workflow/portal-workflow-web/src/main/java/com/liferay/portal/workflow/web/internal/portlet/tab/MyWorkflowInstancePortletTab.java", "patch_func": "no", "diff_file": "liferay-portal_CVE-2021-33333_5eacaf6affe066bb217591467077a86566ab9038.diff", "patch_tag": "7.4.2-ga3", "source_tag": "7.4.1-ga2"}]